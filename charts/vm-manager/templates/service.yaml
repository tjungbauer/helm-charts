{{/*
Kubernetes Service Configuration for Virtual Machines
This template creates Service resources to expose VMs.
*/}}
{{- range $serviceName, $service := .Values.services }}
{{- if $service.enabled }}
{{- /* Validate Service name is a valid Kubernetes name */ -}}
{{- if not (regexMatch "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$" $serviceName) }}
{{- fail (printf "services.%s name must be a valid Kubernetes resource name" $serviceName) }}
{{- end }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ $serviceName | quote }}
  namespace: {{ $service.namespace | default $.Values.global.namespace | default $.Release.Namespace | quote }}
  labels:
    {{- include "tpl.labels" $ | nindent 4 }}
    {{- with $service.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  annotations:
    {{- include "tpl.additionalAnnotations" ($service.annotations | default dict) | nindent 4 }}
spec:
  type: {{ $service.type | default "ClusterIP" | quote }}
  
  {{- with $service.clusterIP }}
  clusterIP: {{ . | quote }}
  {{- end }}
  
  {{- with $service.externalIPs }}
  externalIPs:
    {{- range . }}
    - {{ . | quote }}
    {{- end }}
  {{- end }}
  
  {{- with $service.loadBalancerIP }}
  loadBalancerIP: {{ . | quote }}
  {{- end }}
  
  {{- with $service.loadBalancerSourceRanges }}
  loadBalancerSourceRanges:
    {{- range . }}
    - {{ . | quote }}
    {{- end }}
  {{- end }}
  
  {{- with $service.externalName }}
  externalName: {{ . | quote }}
  {{- end }}
  
  {{- with $service.sessionAffinity }}
  sessionAffinity: {{ . | quote }}
  {{- end }}
  
  {{- with $service.externalTrafficPolicy }}
  externalTrafficPolicy: {{ . | quote }}
  {{- end }}

  ports:
    {{- range $service.ports }}
    - name: {{ .name | quote }}
      port: {{ .port }}
      targetPort: {{ .targetPort | default .port }}
      {{- with .protocol }}
      protocol: {{ . | quote }}
      {{- end }}
      {{- if and (eq ($service.type | default "ClusterIP") "NodePort") .nodePort }}
      nodePort: {{ .nodePort }}
      {{- end }}
    {{- end }}

  selector:
    {{- with $service.selector }}
    {{- toYaml . | nindent 4 }}
    {{- end }}

{{- end }}
{{- end }}
